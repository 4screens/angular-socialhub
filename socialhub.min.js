/*
 4screens-socialhub v0.0.1
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",[]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["$window","$document","SocialhubBackendService",function(e,t,i){var n=function(n,o){i.isotope.init(o),n.$watch(function(){return o.height()},function(){i.infinity.scrollHandler(n,o,e)()}),t.bind("scroll",i.infinity.scrollHandler(n,o,e))};return{restrict:"C",link:n}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubBackendService",function(e){var t=function(){e.isotope.arrange()};return{restrict:"C",link:t}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","socketService","$timeout","$http","$q",function(e,t,i,n,o){function s(e){if(!e)throw"PostId has not been set!";return n.get(d.post.replace(":postid",e)).then(function(e){return 200===e.status?e.data:o.reject(e.data)})}function r(e){return e=e||{},n.get(d.posts,e).then(function(e){return 200===e.status?e.data:o.reject(e.data)})}function a(){0!==u.visibled&&(h.visibled>_.size(h.posts)?r({page:Math.floor(_.size(h.posts)/h.pack)}).then(function(e){_.forEach(e,function(e){h.posts[e._id]=e,h.priority.push(e._id)}),a()}):(_.each(h.priority.slice(0,h.visibled),function(e,t){-1===_.findIndex(f.posts,{_id:e})&&f.posts.splice(t,0,h.posts[e])}),_.remove(f.posts,function(e,t){return t>=h.visibled}),l.method.arrange()))}var c=t.get(e.socialhub.namespace+e.socialhub.id),l={instance:null,container:null,method:{},settings:{classNameTile:".socialhub-isotope-tile-directive"}},u={enabled:!0,method:{},settings:{offset:200,step:10}},d={post:e.backend.domain+e.socialhub.post.replace(":id",e.socialhub.id),posts:e.backend.domain+e.socialhub.posts.replace(":id",e.socialhub.id)},h={pack:50,visibled:0,priority:[],posts:{}},f={posts:[]};return l.method.init=function(e){l.container=e,l.instance=new Isotope(e[0],{itemSelector:l.settings.classNameTile}),window.iso=l},l.method.arrange=_.debounce(function(){l.instance.reloadItems(),l.instance.arrange(),l.method.loadImage(function(){l.instance.arrange(),u.enabled=!0})},100),l.method.loadImage=function(e){var t=imagesLoaded(l.container);t.on("always",function(){e()})},u.method.step=function(){u.enabled&&(h.visibled+=u.settings.step,u.enabled=!1,a())},u.method.scrollHandler=_.throttle(function(e,t,n){return function(){n.innerHeight-t.offset().top+n.scrollY+u.settings.offset>=t.height()&&i(function(){u.method.step()})}},500),c.on("socialhub:newPost",function(e){s(e).then(function(t){-1===_.findIndex(h.priority,e)&&(h.posts[t._id]=t,h.priority.unshift(t._id),a())}).catch(function(t){404===t.status&&(_.remove(h.priority,function(t){return t==e}),_.remove(f.posts,function(t){return t._id==e}),a())})}),{isotope:{init:l.method.init,arrange:l.method.arrange},infinity:{scrollHandler:u.method.scrollHandler},results:f,getResults:a}}]);