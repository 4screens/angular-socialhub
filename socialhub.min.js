/*
 4screens-socialhub v0.0.1
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",["com.2fdevs.videogular","com.2fdevs.videogular.plugins.buffering","com.2fdevs.videogular.plugins.controls","com.2fdevs.videogular.plugins.overlayplay"]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/main.html",'<div class="masonry__iframe" data-ng-if="!!detail"><div class="masonry__iframe--wrapper"><div class="masonry__iframe--navigation"><a href data-ng-click="closeSocial()" class="masonry__iframe--close"><span class="fa-stack fa-lg fa-stack-2x"><i class="fa fa-circle fa-stack-2x fa-inverse"></i> <i class="fa fa-times fa-stack-1x"></i></span></a></div><div class="masonry__iframe--content"><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{ detail.user.avatar }}" alt> <span class="name" ng-bind-html="detail.user.name"></span> <span class="time" am-time-ago="detail.publish"></span></div></figcaption><div class="masonry__tile--fullimage" data-ng-if="detail.image || detail.video"><img data-ng-src="{{ detail.image }}" alt data-ng-if="!detail.video"><videogular data-ng-if="!!detail.video"><vg-video vg-src="detail.video" vg-preload="\'none\'"></vg-video><vg-buffering></vg-buffering><vg-controls vg-autohide="true" vg-autohide-time="1000"><vg-play-pause-button></vg-play-pause-button><vg-timedisplay>{{ currentTime | date:\'mm:ss\' }}</vg-timedisplay><vg-scrubbar><vg-scrubbarcurrenttime></vg-scrubbarcurrenttime></vg-scrubbar><vg-timedisplay>{{ timeLeft | date:\'mm:ss\' }}</vg-timedisplay><vg-timedisplay>{{ totalTime | date:\'mm:ss\' }}</vg-timedisplay><vg-volume><vg-mutebutton></vg-mutebutton><vg-volumebar></vg-volumebar></vg-volume><vg-fullscreenbutton></vg-fullscreenbutton></vg-controls><vg-overlay-play></vg-overlay-play></videogular></div><figcaption class="masonry__tile--signature"><p class="masonry__tile--signature-caption" ng-bind-html="detail.message | emoji"></p></figcaption></div></div><div class="masonry__iframe--background"></div></div><div><div class="masonry__newest" data-ng-if="!!sh.newest.posts.length" data-ng-click="sh.renderNewest()">New: {{ sh.newest.posts.length }}</div></div><div class="masonry socialhub-isotope-directive"><article class="masonry__tile socialhub-isotope-tile-directive" data-ng-include="\'views/socialhub/tile-\' + post.source + \'.html\'" data-ng-repeat="post in sh.results.posts track by post._id"></article></div><div class="masonry__preloader" data-ng-if="!sh.complete.value"><i class="fa fa-spinner fa-spin"></i></div>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-facebook.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.type==\'photo\' || post.type ==\'video\'"><img data-ng-src="{{post.photo.source}}" data-ng-class="ratio( post.photo.width, post.photo.height )" alt data-ng-if="post.type==\'photo\'"> <img data-ng-src="{{post.video.image}}" alt data-ng-if="post.type==\'video\'"> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.from.image}}" alt> <span class="name" ng-bind-html="post.from.name"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption">{{ post.message || post.description || post.caption || post.story }}</p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-instagram.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img data-ng-src="{{post.images.standard_resolution.url}}" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user.profile_picture}}" alt> <span class="name" ng-bind-html="post.user.full_name | emoji"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-twitter.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img data-ng-src="{{post.images.media_url}}" data-ng-class="ratio( post.images.sizes.small.w, post.images.sizes.small.h )" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user_image_url}}" alt> <span class="name" ng-bind-html="post.user"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").controller("socialhubDefaultCtrl",["SocialhubBackendService","$rootScope","$scope","$timeout","$sce","$analytics",function(a,e,i,s,t,o){i.sh=a,i.sh.renderVisibled(),i.detail=null,i.ratio=function(a,e,i){return i?i:a>e?"verticale":e>a?"horizontal":void 0},i.openSocial=function(a){i.detail={},e.noscroll=!0,"instagram"===a.source?(a.images&&(i.detail.image=a.images.standard_resolution.url),"video"===a.type&&(i.detail.video=[{src:t.trustAsResourceUrl(a.videos.standard_resolution.url),type:"video/mp4"}]),i.detail.user={name:a.user.username,avatar:a.user.profile_picture},i.detail.publish=a.created_time,i.detail.message=a.caption):"facebook"===a.source?(a.photo&&(i.detail.image=a.photo.source),"video"===a.type&&(i.detail.video=[{src:t.trustAsResourceUrl(a.video.source),type:"video/mp4"}]),i.detail.user={name:a.from.name,avatar:a.from.image},i.detail.publish=a.created_time,i.detail.message=a.message||a.description||a.caption||a.story):"twitter"===a.source&&(a.images&&(i.detail.image=a.images.media_url),i.detail.user={name:a.user,avatar:a.user_image_url},i.detail.publish=a.created_time,i.detail.message=a.caption),o.eventTrack("Open item",{category:"Social Hub",label:a._id})},i.closeSocial=function(){i.detail=null,e.noscroll=!1,o.eventTrack("Close item",{category:"Social Hub",label:"Close item"})}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["SocialhubIsotopeService","SocialhubInfinityService","$window","$document",function(a,e,i,s){var t=function(t,o){a.init(o),s.unbind("scroll"),s.bind("scroll",e.scrollHandler(t,o,i))};return{restrict:"C",link:t}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubIsotopeService",function(a){var e=function(e,i){a.addItem(i,e.$index)};return{restrict:"C",link:e}}]),angular.module("4screens.socialhub").factory("SocialhubInfinityService",["SocialhubBackendService",function(a){function e(){s=!0}var i,s=!0,t=1500,o=10;return i=_.throttle(function(e,i,n){return function(){n.innerHeight-i.offset().top+n.scrollY+t>=i.height()&&s&&(s=!1,a.renderVisibled(o))}},500),{scrollHandler:i,enable:e}}]),angular.module("4screens.socialhub").factory("SocialhubIsotopeService",["SocialhubInfinityService","$document","$timeout",function(a,e,i){function s(a){n=a,o=new Isotope(a[0],l)}function t(a,e){i(function(){0===e?o.prepended(a[0]):o.appended(a[0])})}var o=null,n=null,l={itemSelector:".socialhub-isotope-tile-directive",transitionDuration:"0.1s"};return e.bind("isotopeArrange",function(){i(function(){i(function(){o.arrange(),a.enable(),e.triggerHandler("scroll")})})}),e.bind("isotopeReload",function(){i(function(){i(function(){o.reloadItems(),o.arrange(),a.enable(),e.triggerHandler("scroll")})})}),{init:s,addItem:t}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","socketService","$http","$document","$window",function(a,e,i,s,t){function o(e){if(!e)throw"PostId has not been set!";return i.get(a.backend.domain+a.socialhub.post.replace(":id",a.socialhub.id).replace(":postid",e)).then(function(a){return 200===a.status?a.data:$q.reject(a.data)})}function n(e){return e=e||{},i.get(a.backend.domain+a.socialhub.posts.replace(":id",a.socialhub.id),{params:e}).then(function(a){return 200===a.status?a.data:$q.reject(a.data)})}function l(a,e){c+=a||0,e=e||!1,c>_.size(m)&&u.value===!1?n({page:Math.floor(_.size(m)/d)}).then(function(a){a.length<50&&(u.value=!0),_.forEach(a,function(a){-1===_.findIndex(g,a._id)&&(m[a._id]=a,g.push(a._id))}),g.length>c&&l()}):(_.each(g.slice(0,c),function(a,e){-1===_.findIndex(f,{_id:a})&&f.splice(e,0,m[a])}),_.remove(f,function(a,e){return e>=c}),e===!1?s.triggerHandler("isotopeArrange"):s.triggerHandler("isotopeReload"),u.value===!0&&g.length===c&&s.unbind("scroll"))}function r(){for(g=p.concat(g),g=g.slice(0,c);p.length>0;)p.pop();l(0,!0)}var c=0,d=50,u={value:!1},g=[],p=[],m={},f=[];return e.get(a.socialhub.namespace+a.socialhub.id).on("socialhub:newPost",function(a){o(a).then(function(e){-1===_.findIndex(g,a)&&(m[e._id]=e,0===t.scrollY&&0===p.length?(g.unshift(e._id),c++,l()):p.unshift(e._id))}).catch(function(e){(404===e.status||500===e.status)&&(_.remove(g,function(e){return e===a}),_.remove(f,function(e){return e._id===a}),s.triggerHandler("isotopeReload"))})}),{renderVisibled:l,renderNewest:r,newest:{posts:p},complete:u,results:{posts:f}}}]);