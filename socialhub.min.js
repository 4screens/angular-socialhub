/*
 4screens-socialhub v0.1.9
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",["4screens.common","4screens.settings","com.2fdevs.videogular","com.2fdevs.videogular.plugins.buffering","com.2fdevs.videogular.plugins.controls","com.2fdevs.videogular.plugins.overlayplay","com.2fdevs.videogular.plugins.poster","angulartics","angulartics.google.analytics","angularMoment"]),angular.module("4screens.socialhub").run(["$templateCache",function(e){e.put("views/socialhub/main.html",'<link rel="stylesheet" type="text/css" data-ng-href="{{ customThemeCssFile || staticThemeCssFile }}" data-ng-if="!!customThemeCssFile || !!staticThemeCssFile"><div class="masonry__iframe" data-ng-if="!!detail"><div class="masonry__iframe--wrapper"><div class="masonry__iframe--navigation"><a href data-ng-click="closeSocial()" class="masonry__iframe--close"><span class="fa-stack fa-lg fa-stack-2x"><i class="fa fa-times fa-stack-1x"></i></span></a></div><div class="masonry__iframe--content"><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{ detail.user.avatar }}" alt> <span class="name" ng-bind-html="detail.user.name"></span> <span class="time" am-time-ago="detail.publish"></span></div></figcaption><div class="masonry__tile--fullimage" data-ng-if="detail.image || detail.video"><img data-ng-src="{{ detail.image }}" alt data-ng-if="!detail.video"><videogular data-ng-if="!!detail.video"><vg-video vg-src="detail.video"></vg-video><vg-buffering></vg-buffering><vg-controls vg-autohide="true" vg-autohide-time="1000"><vg-play-pause-button></vg-play-pause-button><vg-timedisplay>{{ currentTime | date:\'mm:ss\' }}</vg-timedisplay><vg-scrubbar><vg-scrubbarcurrenttime></vg-scrubbarcurrenttime></vg-scrubbar><vg-timedisplay>{{ timeLeft | date:\'mm:ss\' }}</vg-timedisplay><vg-timedisplay>{{ totalTime | date:\'mm:ss\' }}</vg-timedisplay><vg-volume><vg-mutebutton></vg-mutebutton><vg-volumebar></vg-volumebar></vg-volume><vg-fullscreenbutton></vg-fullscreenbutton></vg-controls><vg-overlay-play></vg-overlay-play><vg-poster-image vg-url="detail.image"></vg-poster-image></videogular></div><figcaption class="masonry__tile--signature"><p class="masonry__tile--signature-caption" ng-bind-html="detail.message | emoji"></p></figcaption></div></div><div class="masonry__iframe--background"></div></div><div><div class="masonry__newest" data-ng-if="!!sh.newest.posts.length" data-ng-click="sh.renderNewest()">New: {{ sh.newest.posts.length }}</div></div><div class="masonry socialhub-isotope-directive" data-ng-if="sh.widgetId"><article class="masonry__tile socialhub-isotope-tile-directive masonary__type" ng-class="\'masonary__type--\' + post.source" data-ng-include="\'views/socialhub/tile-\' + post.source + \'.html\'" data-ng-repeat="post in sh.results.posts track by post._id"></article></div><div class="masonry__preloader masonry__button" data-ng-if="sh.complete.infiniteScroll || !sh.results.posts.length"><i class="fa fa-spinner fa-spin"></i></div><div class="masonry__preloader" data-ng-if="!sh.complete.infiniteScroll && sh.results.posts.length"><button data-ng-click="renderMore()" class="masonry__button">show more</button></div>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(e){e.put("views/socialhub/tile-facebook.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.type==\'photo\' || post.type ==\'video\'"><img data-ng-src="{{post.photo.source}}" data-ng-class="ratio( post.photo.width, post.photo.height )" alt data-ng-if="post.type==\'photo\'"> <img data-ng-src="{{post.video.image}}" alt data-ng-if="post.type==\'video\'"> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.from.image}}" alt> <span class="name" ng-bind-html="post.from.name"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption">{{ post.message || post.description || post.caption || post.story }}</p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(e){e.put("views/socialhub/tile-instagram.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img data-ng-src="{{post.images.standard_resolution.url}}" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user.profile_picture}}" alt> <span class="name" data-ng-bind="post.user.username"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(e){e.put("views/socialhub/tile-twitter.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img data-ng-src="{{post.images.media_url}}" data-ng-class="ratio( post.images.sizes.small.w, post.images.sizes.small.h )" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user_image_url}}" alt> <span class="name" ng-bind-html="post.user"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").controller("socialhubDefaultCtrl",["CONFIG","SocialhubBackendService","SettingsSocialhubService","$rootScope","$scope","$routeParams","$sce","$analytics",function(e,a,i,t,s,o,n,l){s.sh=a,s.detail=null,i.get(o.shWidgetId||e.frontend.socialhubWidget.id).then(function(i){e.frontend.socialhub.id=i.socialHubId,i.theme=i.theme||{},i.theme.customThemeCssFile&&(s.staticThemeCssFile=e.backend.domain.replace(":subdomain","")+"/uploads/"+i.theme.customThemeCssFile),a.widgetId=i._id,a.complete.infiniteScroll=!!(i.config||{}).infiniteScroll,a.renderVisibled(a.complete.infiniteScroll?0:10)}),s.ratio=function(e,a,i){return i?i:e>a?"verticale":a>e?"horizontal":void 0},s.openSocial=function(e){s.detail={},t.noscroll=!0,"instagram"===e.source?(e.images&&(s.detail.image=e.images.standard_resolution.url),"video"===e.type&&(s.detail.video=[{src:n.trustAsResourceUrl(e.videos.standard_resolution.url),type:"video/mp4"}]),s.detail.user={name:e.user.username,avatar:e.user.profile_picture},s.detail.publish=e.created_time,s.detail.message=e.caption):"facebook"===e.source?(e.photo&&(s.detail.image=e.photo.source),"video"===e.type&&(s.detail.video=[{src:n.trustAsResourceUrl(e.video.source),type:"video/mp4"}]),s.detail.user={name:e.from.name,avatar:e.from.image},s.detail.publish=e.created_time,s.detail.message=e.message||e.description||e.caption||e.story):"twitter"===e.source&&(e.images&&(s.detail.image=e.images.media_url),s.detail.user={name:e.user,avatar:e.user_image_url},s.detail.publish=e.created_time,s.detail.message=e.caption),l.eventTrack("Open item",{category:"Social Hub",label:e._id})},s.closeSocial=function(){s.detail=null,t.noscroll=!1,l.eventTrack("Close item",{category:"Social Hub",label:"Close item"})},s.renderMore=function(){a.renderVisibled(10)}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["SocialhubIsotopeService","SocialhubInfinityService","$window","$document",function(e,a,i,t){var s=function(s,o){e.init(o),t.unbind("scroll"),t.bind("scroll",a.scrollHandler(s,o,i))};return{restrict:"C",link:s}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubIsotopeService",function(e){var a=function(a,i){e.addItem(i,a.$index)};return{restrict:"C",link:a}}]),angular.module("4screens.socialhub").filter("emoji",["$sanitize",function(e){var a={};return function(i){var t="";return"undefined"==typeof i||null===i?"":a[i]?a[i]:(i=i||"",t=e(emojione.toImage(i)),a[i]=t,t)}}]),angular.module("4screens.socialhub").factory("SocialhubInfinityService",["SocialhubBackendService",function(e){function a(){t=!0}var i,t=!0,s=1500,o=10;return i=_.throttle(function(a,i,n){return function(){e.complete.infiniteScroll&&n.innerHeight-i.prop("offsetTop")+n.scrollY+s>=parseInt(i.css("height"),10)&&t&&(t=!1,e.renderVisibled(o))}},500),{scrollHandler:i,enable:a}}]),angular.module("4screens.socialhub").factory("SocialhubIsotopeService",["SocialhubInfinityService","$rootScope","$document","$timeout",function(e,a,i,t){function s(e){l=e,n=new Isotope(e[0],r)}function o(e,a){t(function(){0===a?n.prepended(e[0]):n.appended(e[0])})}var n=null,l=null,r={itemSelector:".socialhub-isotope-tile-directive",transitionDuration:"0.1s"};return a.$on("isotopeArrange",function(){t(function(){t(function(){t(function(){n.arrange(),e.enable(),i.triggerHandler("scroll")})})})}),a.$on("isotopeReload",function(){t(function(){t(function(){t(function(){n.reloadItems(),n.arrange(),e.enable(),i.triggerHandler("scroll")})})})}),{init:s,addItem:o}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","CommonSocketService","$rootScope","$http","$q","$document","$window",function(e,a,i,t,s,o,n){function l(a){if(!a)throw"PostId has not been set!";return t.get(e.backend.domain.replace(":subdomain","")+e.frontend.socialhub.post.replace(":id",e.frontend.socialhub.id).replace(":postid",a)).then(function(e){return 200===e.status?e.data:s.reject(e.data)})}function r(a){return a=a||{},t.get(e.backend.domain.replace(":subdomain","")+e.frontend.socialhub.posts.replace(":id",e.frontend.socialhub.id),{params:a}).then(function(e){return 200===e.status?e.data:s.reject(e.data)})}function c(e,a){u+=e||0,a=a||!1,u>_.size(v)&&g.value===!1?r({page:Math.floor(_.size(v)/m)}).then(function(e){e.length<50&&(g.value=!0),_.forEach(e,function(e){-1===_.findIndex(p,e._id)&&(v[e._id]=e,p.push(e._id))}),p.length>u&&c()}):(_.each(p.slice(0,u),function(e,a){-1===_.findIndex(h,{_id:e})&&h.splice(a,0,v[e])}),_.remove(h,function(e,a){return a>=u}),a===!1?i.$emit("isotopeArrange"):i.$emit("isotopeReload"),g.value===!0&&p.length===u&&o.unbind("scroll"))}function d(){for(p=f.concat(p),p=p.slice(0,u);f.length>0;)f.pop();c(0,!0)}var u=0,m=50,g={value:!1},p=[],f=[],v={},h=[];return a.get(e.frontend.socialhub.namespace+e.frontend.socialhub.id).on("socialhub:newPost",function(e){l(e).then(function(a){-1===_.findIndex(p,e)&&(v[a._id]=a,0===n.scrollY&&0===f.length?(p.unshift(a._id),u++,c()):f.unshift(a._id))}).catch(function(a){(404===a.status||500===a.status)&&(_.remove(p,function(a){return a===e}),_.remove(h,function(a){return a._id===e}),i.$emit("isotopeReload"))})}),{renderVisibled:c,renderNewest:d,newest:{posts:f},complete:g,results:{posts:h}}}]);