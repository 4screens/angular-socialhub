/*
 4screens-socialhub v0.0.1
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",[]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["SocialhubIsotopeService","SocialhubInfinityService","$window","$document",function(e,n,t,i){var o=function(o,r){e.init(r),i.unbind("scroll"),i.bind("scroll",n.scrollHandler(o,r,t))};return{restrict:"C",link:o}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubIsotopeService",function(e){var n=function(n,t){e.addItem(t,n.$index)};return{restrict:"C",link:n}}]),angular.module("4screens.socialhub").factory("SocialhubInfinityService",["SocialhubBackendService",function(e){function n(){i=!0}var t,i=!0,o=800,r=1;return t=_.throttle(function(n,t,c){return function(){c.innerHeight-t.offset().top+c.scrollY+o>=t.height()&&i&&(i=!1,e.renderVisibled(r))}},500),{scrollHandler:t,enable:n}}]),angular.module("4screens.socialhub").factory("SocialhubIsotopeService",["SocialhubInfinityService","$document","$timeout",function(e,n,t){function i(e){a=e,c=new Isotope(e[0],u),window.isotope=c}function o(e,n){t(function(){0===n?c.prepended(e[0]):c.appended(e[0])})}function r(e){var n=imagesLoaded(a);t(function(){c.arrange()}),n.on("always",function(){t(function(){c.arrange(),e.apply(this,arguments)})})}var c=null,a=null,u={itemSelector:".socialhub-isotope-tile-directive",transitionDuration:"0.2s"};n.bind("isotopeArrange",function(){t(function(){s()})}),n.bind("isotopeReload",function(){t(function(){isotope.reloadItems(),isotope.arrange()},100)});var s=_.debounce(function(){r(function(){e.enable(),n.triggerHandler("scroll")})});return{init:i,addItem:o,arrange:s}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","socketService","$http","$document","$window",function(e,n,t,i,o){function r(n){if(!n)throw"PostId has not been set!";return t.get(e.backend.domain+e.socialhub.post.replace(":id",e.socialhub.id).replace(":postid",n)).then(function(e){return 200===e.status?e.data:$q.reject(e.data)})}function c(n){return n=n||{},t.get(e.backend.domain+e.socialhub.posts.replace(":id",e.socialhub.id),{params:n}).then(function(e){return 200===e.status?e.data:$q.reject(e.data)})}function a(e,n){s+=e||0,n=n||!1,s>_.size(p)&&d.value===!1?c({page:Math.floor(_.size(p)/l)}).then(function(e){e.length<50&&(d.value=!0,console.log("complete should be true...",d)),_.forEach(e,function(e){-1===_.findIndex(f,e._id)&&(p[e._id]=e,f.push(e._id))}),f.length>s&&a()}):(_.each(f.slice(0,s),function(e,n){-1===_.findIndex(b,{_id:e})&&b.splice(n,0,p[e])}),_.remove(b,function(e,n){return n>=s}),n===!1?i.triggerHandler("isotopeArrange"):i.triggerHandler("isotopeReload"),d.value===!0&&f.length===s&&i.unbind("scroll"))}function u(){for(f=h.concat(f),f=f.slice(0,s);h.length>0;)h.pop();a(0,!0)}var s=1,l=50,d={value:!1},f=[],h=[],p={},b=[];return n.get(e.socialhub.namespace+e.socialhub.id).on("socialhub:newPost",function(e){r(e).then(function(n){-1===_.findIndex(f,e)&&(p[n._id]=n,0===o.scrollY&&0===h.length?(f.unshift(n._id),s++,a()):h.unshift(n._id))}).catch(function(n){(404===n.status||500===n.status)&&(_.remove(f,function(n){return n===e}),_.remove(b,function(n){return n._id===e}),i.triggerHandler("isotopeReload"))})}),{renderVisibled:a,renderNewest:u,newest:{posts:h},complete:d,results:{posts:b}}}]);