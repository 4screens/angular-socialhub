/*
 4screens-socialhub v0.1.2
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",["4screens.common","4screens.settings","com.2fdevs.videogular","com.2fdevs.videogular.plugins.buffering","com.2fdevs.videogular.plugins.controls","com.2fdevs.videogular.plugins.overlayplay","com.2fdevs.videogular.plugins.poster","angulartics","angulartics.google.analytics","angularMoment"]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/main.html",'<link rel="stylesheet" type="text/css" data-ng-href="{{ customThemeCssFile || staticThemeCssFile }}" data-ng-if="!!customThemeCssFile || !!staticThemeCssFile"><div class="masonry__iframe" data-ng-if="!!detail"><div class="masonry__iframe--wrapper"><div class="masonry__iframe--navigation"><a href data-ng-click="closeSocial()" class="masonry__iframe--close"><span class="fa-stack fa-lg fa-stack-2x"><i class="fa fa-circle fa-stack-2x fa-inverse"></i> <i class="fa fa-times fa-stack-1x"></i></span></a></div><div class="masonry__iframe--content"><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{ detail.user.avatar }}" alt> <span class="name" ng-bind-html="detail.user.name"></span> <span class="time" am-time-ago="detail.publish"></span></div></figcaption><div class="masonry__tile--fullimage" data-ng-if="detail.image || detail.video"><img data-ng-src="{{ detail.image }}" alt data-ng-if="!detail.video"><videogular data-ng-if="!!detail.video"><vg-video vg-src="detail.video"></vg-video><vg-buffering></vg-buffering><vg-controls vg-autohide="true" vg-autohide-time="1000"><vg-play-pause-button></vg-play-pause-button><vg-timedisplay>{{ currentTime | date:\'mm:ss\' }}</vg-timedisplay><vg-scrubbar><vg-scrubbarcurrenttime></vg-scrubbarcurrenttime></vg-scrubbar><vg-timedisplay>{{ timeLeft | date:\'mm:ss\' }}</vg-timedisplay><vg-timedisplay>{{ totalTime | date:\'mm:ss\' }}</vg-timedisplay><vg-volume><vg-mutebutton></vg-mutebutton><vg-volumebar></vg-volumebar></vg-volume><vg-fullscreenbutton></vg-fullscreenbutton></vg-controls><vg-overlay-play></vg-overlay-play><vg-poster-image vg-url="detail.image"></vg-poster-image></videogular></div><figcaption class="masonry__tile--signature"><p class="masonry__tile--signature-caption" ng-bind-html="detail.message | emoji"></p></figcaption></div></div><div class="masonry__iframe--background"></div></div><div><div class="masonry__newest" data-ng-if="!!sh.newest.posts.length" data-ng-click="sh.renderNewest()">New: {{ sh.newest.posts.length }}</div></div><div class="masonry socialhub-isotope-directive"><article class="masonry__tile socialhub-isotope-tile-directive" data-ng-include="\'views/socialhub/tile-\' + post.source + \'.html\'" data-ng-repeat="post in sh.results.posts track by post._id"></article></div><div class="masonry__preloader" data-ng-if="!sh.complete.value"><i class="fa fa-spinner fa-spin"></i></div>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-facebook.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.type==\'photo\' || post.type ==\'video\'"><img data-ng-src="{{post.photo.source}}" data-ng-class="ratio( post.photo.width, post.photo.height )" alt data-ng-if="post.type==\'photo\'"> <img data-ng-src="{{post.video.image}}" alt data-ng-if="post.type==\'video\'"> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.from.image}}" alt> <span class="name" ng-bind-html="post.from.name"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption">{{ post.message || post.description || post.caption || post.story }}</p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-instagram.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img data-ng-src="{{post.images.standard_resolution.url}}" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user.profile_picture}}" alt> <span class="name" data-ng-bind="post.user.username"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-twitter.html",'<figure data-ng-click="openSocial(post)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img data-ng-src="{{post.images.media_url}}" data-ng-class="ratio( post.images.sizes.small.w, post.images.sizes.small.h )" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user_image_url}}" alt> <span class="name" ng-bind-html="post.user"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").controller("socialhubDefaultCtrl",["CONFIG","SocialhubBackendService","SettingsSocialhubService","$rootScope","$scope","$routeParams","$sce","$analytics",function(a,e,i,s,t,n,o,l){t.sh=e,t.detail=null,i.get(n.shWidgetId||a.frontend.socialhubWidget.id).then(function(i){a.frontend.socialhub.id=i.socialHubId,i.theme.customThemeCssFile&&(t.staticThemeCssFile=a.backend.domain.replace(":subdomain","")+"/uploads/"+i.theme.customThemeCssFile),e.renderVisibled()}),t.ratio=function(a,e,i){return i?i:a>e?"verticale":e>a?"horizontal":void 0},t.openSocial=function(a){t.detail={},s.noscroll=!0,"instagram"===a.source?(a.images&&(t.detail.image=a.images.standard_resolution.url),"video"===a.type&&(t.detail.video=[{src:o.trustAsResourceUrl(a.videos.standard_resolution.url),type:"video/mp4"}]),t.detail.user={name:a.user.username,avatar:a.user.profile_picture},t.detail.publish=a.created_time,t.detail.message=a.caption):"facebook"===a.source?(a.photo&&(t.detail.image=a.photo.source),"video"===a.type&&(t.detail.video=[{src:o.trustAsResourceUrl(a.video.source),type:"video/mp4"}]),t.detail.user={name:a.from.name,avatar:a.from.image},t.detail.publish=a.created_time,t.detail.message=a.message||a.description||a.caption||a.story):"twitter"===a.source&&(a.images&&(t.detail.image=a.images.media_url),t.detail.user={name:a.user,avatar:a.user_image_url},t.detail.publish=a.created_time,t.detail.message=a.caption),l.eventTrack("Open item",{category:"Social Hub",label:a._id})},t.closeSocial=function(){t.detail=null,s.noscroll=!1,l.eventTrack("Close item",{category:"Social Hub",label:"Close item"})}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["SocialhubIsotopeService","SocialhubInfinityService","$window","$document",function(a,e,i,s){var t=function(t,n){a.init(n),s.unbind("scroll"),s.bind("scroll",e.scrollHandler(t,n,i))};return{restrict:"C",link:t}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubIsotopeService",function(a){var e=function(e,i){a.addItem(i,e.$index)};return{restrict:"C",link:e}}]),angular.module("4screens.socialhub").filter("emoji",["$sanitize",function(a){var e={};return function(i){var s="";return"undefined"==typeof i||null===i?"":e[i]?e[i]:(i=i||"",s=a(emojione.toImage(i)),e[i]=s,s)}}]),angular.module("4screens.socialhub").factory("SocialhubInfinityService",["SocialhubBackendService",function(a){function e(){s=!0}var i,s=!0,t=1500,n=10;return i=_.throttle(function(e,i,o){return function(){o.innerHeight-i.prop("offsetTop")+o.scrollY+t>=parseInt(i.css("height"),10)&&s&&(s=!1,a.renderVisibled(n))}},500),{scrollHandler:i,enable:e}}]),angular.module("4screens.socialhub").factory("SocialhubIsotopeService",["SocialhubInfinityService","$document","$timeout",function(a,e,i){function s(a){o=a,n=new Isotope(a[0],l)}function t(a,e){i(function(){0===e?n.prepended(a[0]):n.appended(a[0])})}var n=null,o=null,l={itemSelector:".socialhub-isotope-tile-directive",transitionDuration:"0.1s"};return e.bind("isotopeArrange",function(){i(function(){i(function(){i(function(){n.arrange(),a.enable(),e.triggerHandler("scroll")})})})}),e.bind("isotopeReload",function(){i(function(){i(function(){i(function(){n.reloadItems(),n.arrange(),a.enable(),e.triggerHandler("scroll")})})})}),{init:s,addItem:t}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","CommonSocketService","$http","$q","$document","$window",function(a,e,i,s,t,n){function o(e){if(!e)throw"PostId has not been set!";return i.get(a.backend.domain.replace(":subdomain","")+a.frontend.socialhub.post.replace(":id",a.frontend.socialhub.id).replace(":postid",e)).then(function(a){return 200===a.status?a.data:s.reject(a.data)})}function l(e){return e=e||{},i.get(a.backend.domain.replace(":subdomain","")+a.frontend.socialhub.posts.replace(":id",a.frontend.socialhub.id),{params:e}).then(function(a){return 200===a.status?a.data:s.reject(a.data)})}function r(a,e){d+=a||0,e=e||!1,d>_.size(f)&&g.value===!1?l({page:Math.floor(_.size(f)/u)}).then(function(a){a.length<50&&(g.value=!0),_.forEach(a,function(a){-1===_.findIndex(m,a._id)&&(f[a._id]=a,m.push(a._id))}),m.length>d&&r()}):(_.each(m.slice(0,d),function(a,e){-1===_.findIndex(v,{_id:a})&&v.splice(e,0,f[a])}),_.remove(v,function(a,e){return e>=d}),e===!1?t.triggerHandler("isotopeArrange"):t.triggerHandler("isotopeReload"),g.value===!0&&m.length===d&&t.unbind("scroll"))}function c(){for(m=p.concat(m),m=m.slice(0,d);p.length>0;)p.pop();r(0,!0)}var d=0,u=50,g={value:!1},m=[],p=[],f={},v=[];return e.get(a.frontend.socialhub.namespace+a.frontend.socialhub.id).on("socialhub:newPost",function(a){o(a).then(function(e){-1===_.findIndex(m,a)&&(f[e._id]=e,0===n.scrollY&&0===p.length?(m.unshift(e._id),d++,r()):p.unshift(e._id))}).catch(function(e){(404===e.status||500===e.status)&&(_.remove(m,function(e){return e===a}),_.remove(v,function(e){return e._id===a}),t.triggerHandler("isotopeReload"))})}),{renderVisibled:r,renderNewest:c,newest:{posts:p},complete:g,results:{posts:v}}}]);