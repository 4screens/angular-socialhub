/*
 4screens-socialhub v0.0.1
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",[]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["$window","$document","SocialhubBackendService",function(e,t,i){var n=function(n,o){i.isotope.init(o),t.bind("scroll",i.infinity.scrollHandler(n,o,e))};return{restrict:"C",link:n}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubBackendService",function(e){var t=function(t,i){e.isotope.addItem(i),e.isotope.arrange()};return{restrict:"C",link:t}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","socketService","$document","$timeout","$http","$q",function(e,t,i,n,o,s){function r(e){if(!e)throw"PostId has not been set!";return o.get(h.post.replace(":postid",e)).then(function(e){return 200===e.status?e.data:s.reject(e.data)})}function a(e){return e=e||{},o.get(h.posts,{params:e}).then(function(e){return 200===e.status?e.data:s.reject(e.data)})}function c(){0!==u.visibled&&(p.visibled>_.size(p.posts)?a({page:Math.floor(_.size(p.posts)/p.pack)}).then(function(e){_.forEach(e,function(e){p.posts[e._id]=e,p.priority.push(e._id)}),c()}):(_.each(p.priority.slice(0,p.visibled),function(e,t){-1===_.findIndex(m.posts,{_id:e})&&m.posts.splice(t,0,p.posts[e])}),_.remove(m.posts,function(e,t){return t>=p.visibled}),l.method.arrange()))}var d=t.get(e.socialhub.namespace+e.socialhub.id),l={instance:null,container:null,items:[],method:{},settings:{classNameTile:".socialhub-isotope-tile-directive"}},u={enabled:!0,method:{},settings:{offset:200,step:1}},h={post:e.backend.domain+e.socialhub.post.replace(":id",e.socialhub.id),posts:e.backend.domain+e.socialhub.posts.replace(":id",e.socialhub.id)},p={pack:50,visibled:0,priority:[],posts:{}},m={posts:[]};return l.method.init=function(e){l.container=e,l.instance=new Isotope(e[0],{itemSelector:l.settings.classNameTile})},l.method.addItem=function(e){l.items.push(e[0])},l.method.clearItems=function(){l.items=[]},l.method.arrange=_.debounce(function(){l.instance.insert(l.items),l.method.clearItems(),l.method.loadImage(function(){u.enabled=!0,i.triggerHandler("scroll")})},100),l.method.loadImage=function(e){var t=imagesLoaded(l.container);t.on("always",function(){e()})},u.method.step=function(){u.enabled&&(p.visibled+=u.settings.step,u.enabled=!1,c())},u.method.scrollHandler=_.throttle(function(e,t,i){return function(){i.innerHeight-t.offset().top+i.scrollY+u.settings.offset>=t.height()&&n(function(){u.method.step()})}},500),d.on("socialhub:newPost",function(e){r(e).then(function(t){-1===_.findIndex(p.priority,e)&&(p.posts[t._id]=t,p.priority.unshift(t._id),c())}).catch(function(t){404===t.status&&(_.remove(p.priority,function(t){return t==e}),_.remove(m.posts,function(t){return t._id==e}),c())})}),{isotope:{init:l.method.init,addItem:l.method.addItem,arrange:l.method.arrange},infinity:{scrollHandler:u.method.scrollHandler},results:m,getResults:c}}]);