/*
 4screens-socialhub v0.0.1
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",[]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/main.html",'<div class="masonry__iframe" data-ng-if="showSocial"><div class="masonry__iframe--navigation"><a href data-ng-click="closeSocial()" class="masonry__iframe--close"><span class="fa-stack fa-lg fa-stack-2x"><i class="fa fa-circle fa-stack-2x fa-inverse"></i> <i class="fa fa-times fa-stack-1x"></i></span></a></div><iframe width="100%" height="100%" data-ng-src="{{ datasrc }}" frameborder="0"></iframe><div class="masonry__iframe--background"></div></div><div><div class="masonry__newest" data-ng-if="!!sh.newest.posts.length" data-ng-click="sh.renderNewest()">Dodano nowych posów: {{ sh.newest.posts.length }}</div></div><div class="masonry socialhub-isotope-directive"><article class="masonry__tile socialhub-isotope-tile-directive" data-ng-include="\'views/socialhub/tile-\' + post.source + \'.html\'" data-ng-repeat="post in sh.results.posts track by post._id"></article></div><div class="masonry__preloader" data-ng-if="!sh.complete.value">Wczytywanie postów...</div>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-facebook.html",'<figure data-ng-click="openSocial(post._id)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.type==\'photo\' || post.type ==\'video\'"><img ng-src="{{post.photo.source}}" alt data-ng-if="post.type==\'photo\'"> <img ng-src="{{post.video.image}}" alt data-ng-if="post.type==\'video\'"> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.from.image}}" alt> <span class="name" ng-bind-html="post.from.name"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.message | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-instagram.html",'<figure data-ng-click="openSocial(post._id)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img ng-src="{{post.images.standard_resolution.url}}" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user.profile_picture}}" alt> <span class="name" ng-bind-html="post.user.full_name | emoji"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").run(["$templateCache",function(a){a.put("views/socialhub/tile-twitter.html",'<figure data-ng-click="openSocial(post._id)"><div class="masonry__tile--social" data-ng-class="\'masonry__tile--social-\'+ post.source"><i class="fa" data-ng-class="\'fa-\'+ post.source"></i></div><div class="masonry__tile--image" data-ng-show="post.images"><img ng-src="{{post.images.media_url}}" alt> <span class="fa-stack fa-lg" data-ng-if="post.type==\'video\'"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-play fa-stack-1x fa-inverse"></i></span></div><figcaption class="masonry__tile--signature"><div class="masonry__tile--signature-avatar"><img data-ng-src="{{post.user_image_url}}" alt> <span class="name" ng-bind-html="post.user"></span> <span class="time" am-time-ago="post.created_time"></span></div><p class="masonry__tile--signature-caption" ng-bind-html="post.caption | emoji"></p></figcaption></figure>')}]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["SocialhubIsotopeService","SocialhubInfinityService","$window","$document",function(a,i,s,e){var t=function(t,n){a.init(n),e.unbind("scroll"),e.bind("scroll",i.scrollHandler(t,n,s))};return{restrict:"C",link:t}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubIsotopeService",function(a){var i=function(i,s){a.addItem(s,i.$index)};return{restrict:"C",link:i}}]),angular.module("4screens.socialhub").factory("SocialhubInfinityService",["SocialhubBackendService",function(a){function i(){e=!0}var s,e=!0,t=800,n=1;return s=_.throttle(function(i,s,o){return function(){o.innerHeight-s.offset().top+o.scrollY+t>=s.height()&&e&&(e=!1,a.renderVisibled(n))}},500),{scrollHandler:s,enable:i}}]),angular.module("4screens.socialhub").factory("SocialhubIsotopeService",["SocialhubInfinityService","$document","$timeout",function(a,i,s){function e(a){c=a,o=new Isotope(a[0],l)}function t(a,i){s(function(){0===i?o.prepended(a[0]):o.appended(a[0])})}function n(a){var i=imagesLoaded(c);s(function(){o.arrange()}),i.on("always",function(){s(function(){o.arrange(),a.apply(this,arguments)})})}var o=null,c=null,l={itemSelector:".socialhub-isotope-tile-directive",transitionDuration:"0.2s"};i.bind("isotopeArrange",function(){s(function(){r()})}),i.bind("isotopeReload",function(){s(function(){isotope.reloadItems(),isotope.arrange()},100)});var r=_.debounce(function(){n(function(){a.enable(),i.triggerHandler("scroll")})});return{init:e,addItem:t,arrange:r}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","socketService","$http","$document","$window",function(a,i,s,e,t){function n(i){if(!i)throw"PostId has not been set!";return s.get(a.backend.domain+a.socialhub.post.replace(":id",a.socialhub.id).replace(":postid",i)).then(function(a){return 200===a.status?a.data:$q.reject(a.data)})}function o(i){return i=i||{},s.get(a.backend.domain+a.socialhub.posts.replace(":id",a.socialhub.id),{params:i}).then(function(a){return 200===a.status?a.data:$q.reject(a.data)})}function c(a,i){r+=a||0,i=i||!1,r>_.size(g)&&d.value===!1?o({page:Math.floor(_.size(g)/u)}).then(function(a){a.length<50&&(d.value=!0),_.forEach(a,function(a){-1===_.findIndex(p,a._id)&&(g[a._id]=a,p.push(a._id))}),p.length>r&&c()}):(_.each(p.slice(0,r),function(a,i){-1===_.findIndex(m,{_id:a})&&m.splice(i,0,g[a])}),_.remove(m,function(a,i){return i>=r}),i===!1?e.triggerHandler("isotopeArrange"):e.triggerHandler("isotopeReload"),d.value===!0&&p.length===r&&e.unbind("scroll"))}function l(){for(p=f.concat(p),p=p.slice(0,r);f.length>0;)f.pop();c(0,!0)}var r=1,u=50,d={value:!1},p=[],f=[],g={},m=[];return i.get(a.socialhub.namespace+a.socialhub.id).on("socialhub:newPost",function(a){n(a).then(function(i){-1===_.findIndex(p,a)&&(g[i._id]=i,0===t.scrollY&&0===f.length?(p.unshift(i._id),r++,c()):f.unshift(i._id))}).catch(function(i){(404===i.status||500===i.status)&&(_.remove(p,function(i){return i===a}),_.remove(m,function(i){return i._id===a}),e.triggerHandler("isotopeReload"))})}),{renderVisibled:c,renderNewest:l,newest:{posts:f},complete:d,results:{posts:m}}}]);