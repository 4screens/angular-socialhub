/*
 4screens-socialhub v0.0.1
 (c) 2014 Nopattern sp. z o.o.
 License: proprietary
*/
"use strict";angular.module("4screens.socialhub",[]),angular.module("4screens.socialhub").directive("socialhubIsotopeDirective",["SocialhubIsotopeService","SocialhubInfinityService","$window","$document",function(e,n,i,t){var o=function(o,r){e.init(r),t.unbind("scroll"),t.bind("scroll",n.scrollHandler(o,r,i))};return{restrict:"C",link:o}}]),angular.module("4screens.socialhub").directive("socialhubIsotopeTileDirective",["SocialhubIsotopeService",function(e){var n=function(n,i){e.addItem(i,n.$index)};return{restrict:"C",link:n}}]),angular.module("4screens.socialhub").factory("SocialhubInfinityService",["SocialhubBackendService",function(e){function n(){t=!0}var i,t=!0,o=800,r=1;return i=_.throttle(function(n,i,c){return function(){c.innerHeight-i.offset().top+c.scrollY+o>=i.height()&&t&&(t=!1,e.renderVisibled(r))}},500),{scrollHandler:i,enable:n}}]),angular.module("4screens.socialhub").factory("SocialhubIsotopeService",["SocialhubInfinityService","$document","$timeout",function(e,n,i){function t(e){a=e,c=new Isotope(e[0],u),window.isotope=c}function o(e,n){i(function(){0===n?c.prepended(e[0]):c.appended(e[0])})}function r(e){var n=imagesLoaded(a);i(function(){c.arrange()}),n.on("always",function(){i(function(){c.arrange(),e.apply(this,arguments)})})}var c=null,a=null,u={itemSelector:".socialhub-isotope-tile-directive",transitionDuration:"0.2s"};n.bind("isotopeArrange",function(){i(function(){s()})}),n.bind("isotopeRemove",function(){i(function(){isotope.reloadItems(),isotope.arrange()})});var s=_.debounce(function(){r(function(){e.enable(),n.triggerHandler("scroll")})});return{init:t,addItem:o,arrange:s}}]),angular.module("4screens.socialhub").factory("SocialhubBackendService",["CONFIG","socketService","$http","$document",function(e,n,i,t){function o(n){if(!n)throw"PostId has not been set!";return i.get(e.backend.domain+e.socialhub.post.replace(":id",e.socialhub.id).replace(":postid",n)).then(function(e){return 200===e.status?e.data:$q.reject(e.data)})}function r(n){return n=n||{},i.get(e.backend.domain+e.socialhub.posts.replace(":id",e.socialhub.id),{params:n}).then(function(e){return 200===e.status?e.data:$q.reject(e.data)})}function c(e){a+=e||0,console.log("renderVisibled",a),a>_.size(l)?r({page:Math.floor(_.size(l)/u)}).then(function(e){_.forEach(e,function(e){l[e._id]=e,s.push(e._id)}),s.length>a&&c()}):(_.each(s.slice(0,a),function(e,n){-1===_.findIndex(d,{_id:e})&&d.splice(n,0,l[e])}),_.remove(d,function(e,n){return n>=a}),t.triggerHandler("isotopeArrange"))}var a=1,u=50,s=[],l={},d=[];return n.get(e.socialhub.namespace+e.socialhub.id).on("socialhub:newPost",function(e){o(e).then(function(n){-1===_.findIndex(s,e)&&(l[n._id]=n,s.unshift(n._id),s.pop(),c())}).catch(function(n){(404===n.status||500===n.status)&&(_.remove(s,function(n){return n===e}),_.remove(d,function(n){return n._id===e}),t.triggerHandler("isotopeRemove"))})}),{renderVisibled:c,results:{posts:d}}}]);